<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - Database Manager</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo">Database</div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/users.html">Users</a></li>
                <li><a href="/products.html" class="active">Products</a></li>
                <li id="login-link"><a href="/login.html">Login</a></li>
                <li id="user-greeting" style="display: none;">
                    <span class="greeting-text">Hello, <span id="user-name"></span>!</span>
                </li>
                <li id="logout-btn-container" style="display: none;">
                    <button onclick="handleLogout()" class="btn-logout">Logout</button>
                </li>
            </ul>
        </nav>
    </header>
    <main>
        <div class="container">
            <div class="page-header">
                <h1>ðŸ“¦ Products Database</h1>
                <p id="product-count">Loading...</p>
                <button id="add-product-btn" class="btn btn-primary" onclick="openAddModal()" style="display: none;">
                    âž• Add Product
                </button>
            </div>
            <div id="loading" class="loading">Loading products...</div>
            <div id="error" class="error" style="display: none;"></div>
            <div id="success" class="success" style="display: none;"></div>
            <div id="products-container" class="table-container">
                <table id="products-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Item Name</th>
                            <th>Category</th>
                            <th>Brand</th>
                            <th>Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="products-tbody">
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    
    <!-- View Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="productDetail"></div>
        </div>
    </div>
    
    <!-- Add/Edit Modal -->
    <div id="formModal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" onclick="closeFormModal()">&times;</span>
            <div class="detail-card">
                <h2 id="form-title">âž• Add Product</h2>
                <form id="product-form" onsubmit="handleFormSubmit(event)">
                    <input type="hidden" id="form-id">
                    <input type="hidden" id="form-mode" value="add">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="form-sku">SKU</label>
                            <input type="text" id="form-sku" placeholder="Product SKU">
                        </div>
                        <div class="form-group">
                            <label for="form-item_name">Item Name <span class="required">*</span></label>
                            <input type="text" id="form-item_name" required placeholder="Product Name">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="form-category">Category</label>
                            <input type="text" id="form-category" placeholder="Category">
                        </div>
                        <div class="form-group">
                            <label for="form-brand">Brand</label>
                            <input type="text" id="form-brand" placeholder="Brand">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="form-price">Price <span class="required">*</span></label>
                        <input type="number" id="form-price" required placeholder="0" step="0.01">
                    </div>
                    
                    <div class="form-group">
                        <label for="form-description">Description</label>
                        <textarea id="form-description" rows="4" placeholder="Product description"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="form-submit-btn">Save Product</button>
                </form>
            </div>
        </div>
    </div>
    
    <footer>
        <p>&copy; 2025 Database Faiz</p>
    </footer>
    <script>
        window.addEventListener('load', () => {
            updateNavigation();
            loadProducts();
        });
        
        function updateNavigation() {
            const user = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            const loginLink = document.getElementById('login-link');
            const userGreeting = document.getElementById('user-greeting');
            const userName = document.getElementById('user-name');
            const logoutBtn = document.getElementById('logout-btn-container');
            const addBtn = document.getElementById('add-product-btn');
            
            if (user && token) {
                const userData = JSON.parse(user);
                const displayName = userData.nick_name || userData.full_name || 'User';
                
                if (loginLink) loginLink.style.display = 'none';
                if (userGreeting) userGreeting.style.display = 'block';
                if (userName) userName.textContent = displayName;
                if (logoutBtn) logoutBtn.style.display = 'block';
                if (addBtn) addBtn.style.display = 'inline-block';
            } else {
                if (loginLink) loginLink.style.display = 'block';
                if (userGreeting) userGreeting.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'none';
                if (addBtn) addBtn.style.display = 'none';
            }
        }
        
        function handleLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('tokenExpiry');
            alert('âœ… Logged out successfully');
            window.location.href = '/';
        }
        
        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                
                if (data.success) {
                    document.getElementById('product-count').textContent = `Total Products: ${data.count}`;
                    displayProducts(data.data);
                } else {
                    showError('Failed to load products');
                }
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showError('Error connecting to server: ' + error.message);
            }
        }
        
        function displayProducts(products) {
            const tbody = document.getElementById('products-tbody');
            const token = localStorage.getItem('token');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No products found</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>${product.sku || 'N/A'}</td>
                    <td>${product.item_name || product.name || 'N/A'}</td>
                    <td>${product.category || 'N/A'}</td>
                    <td>${product.brand || 'N/A'}</td>
                    <td>${product.price ? 'Rp ' + formatPrice(product.price) : 'N/A'}</td>
                    <td class="action-buttons">
                        <button class="btn-small btn-view" onclick="viewProduct('${product.id}')">View</button>
                        ${token ? `
                            <button class="btn-small btn-edit" onclick='openEditModal(${JSON.stringify(product).replace(/'/g, "&apos;")})'>Edit</button>
                            <button class="btn-small btn-delete" onclick='deleteProduct("${product.id}", "${product.item_name || product.name}")'>Delete</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        function formatPrice(price) {
            return new Intl.NumberFormat('id-ID').format(price);
        }
        
        async function viewProduct(id) {
            try {
                const response = await fetch(`/api/products/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    showProductDetail(data.data);
                } else {
                    alert('Failed to load product details');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function showProductDetail(product) {
            const modal = document.getElementById('productModal');
            const detailDiv = document.getElementById('productDetail');
            
            let mediaHtml = '';
            if (product.media) {
                try {
                    const media = typeof product.media === 'string' ? JSON.parse(product.media) : product.media;
                    
                    if (media.images && Array.isArray(media.images)) {
                        mediaHtml = media.images
                            .filter(img => img.type === 'image')
                            .map(img => `
                                <div class="product-media-item">
                                    <img src="${img.url}" alt="Product Image" onerror="this.src='https://via.placeholder.com/300x300/667eea/ffffff?text=No+Image'">
                                </div>
                            `).join('');
                    } else if (Array.isArray(media)) {
                        mediaHtml = media
                            .filter(img => img.type === 'image')
                            .map(img => `
                                <div class="product-media-item">
                                    <img src="${img.url}" alt="Product Image" onerror="this.src='https://via.placeholder.com/300x300/667eea/ffffff?text=No+Image'">
                                </div>
                            `).join('');
                    }
                    
                    if (!mediaHtml) {
                        mediaHtml = `
                            <div class="product-media-item">
                                <img src="https://via.placeholder.com/300x300/667eea/ffffff?text=No+Image" alt="No Image">
                            </div>
                        `;
                    }
                } catch (e) {
                    mediaHtml = `
                        <div class="product-media-item">
                            <img src="https://via.placeholder.com/300x300/667eea/ffffff?text=Error+Loading+Image" alt="Error">
                        </div>
                    `;
                }
            } else {
                mediaHtml = `
                    <div class="product-media-item">
                        <img src="https://via.placeholder.com/300x300/667eea/ffffff?text=No+Image" alt="No Image">
                    </div>
                `;
            }
            
            detailDiv.innerHTML = `
                <div class="detail-card product-detail">
                    <h2>ðŸ“¦ Product Details</h2>
                    
                    <div class="product-media-container">
                        ${mediaHtml}
                    </div>
                    
                    <div class="detail-info">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">ID:</span>
                                <span class="info-value">${product.id}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">SKU:</span>
                                <span class="info-value">${product.sku || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Item Name:</span>
                                <span class="info-value">${product.item_name || product.name || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Category:</span>
                                <span class="info-value">${product.category || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Brand:</span>
                                <span class="info-value">${product.brand || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Price:</span>
                                <span class="info-value price-highlight">${product.price ? 'Rp ' + formatPrice(product.price) : 'N/A'}</span>
                            </div>
                            <div class="info-item full-width">
                                <span class="info-label">Description:</span>
                                <span class="info-value">${product.description || 'No description available'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function openAddModal() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please login first');
                return;
            }
            
            document.getElementById('form-title').textContent = 'âž• Add Product';
            document.getElementById('form-mode').value = 'add';
            document.getElementById('product-form').reset();
            document.getElementById('form-id').value = '';
            document.getElementById('form-submit-btn').textContent = 'Add Product';
            document.getElementById('formModal').style.display = 'block';
        }
        
        function openEditModal(product) {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please login first');
                return;
            }
            
            document.getElementById('form-title').textContent = 'âœï¸ Edit Product';
            document.getElementById('form-mode').value = 'edit';
            document.getElementById('form-id').value = product.id;
            document.getElementById('form-sku').value = product.sku || '';
            document.getElementById('form-item_name').value = product.item_name || '';
            document.getElementById('form-category').value = product.category || '';
            document.getElementById('form-brand').value = product.brand || '';
            document.getElementById('form-price').value = product.price || '';
            document.getElementById('form-description').value = product.description || '';
            document.getElementById('form-submit-btn').textContent = 'Save Changes';
            document.getElementById('formModal').style.display = 'block';
        }
        
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please login first');
                return;
            }
            
            const mode = document.getElementById('form-mode').value;
            const id = document.getElementById('form-id').value;
            
            const formData = {
                sku: document.getElementById('form-sku').value,
                item_name: document.getElementById('form-item_name').value,
                category: document.getElementById('form-category').value,
                brand: document.getElementById('form-brand').value,
                price: parseFloat(document.getElementById('form-price').value),
                description: document.getElementById('form-description').value,
                media: null
            };
            
            try {
                const url = mode === 'add' ? '/api/products' : `/api/products/${id}`;
                const method = mode === 'add' ? 'POST' : 'PUT';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(mode === 'add' ? 'Product added successfully!' : 'Product updated successfully!');
                    closeFormModal();
                    loadProducts();
                } else {
                    showError(data.error || 'Operation failed');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }
        
        async function deleteProduct(id, name) {
            const token = localStorage.getItem('token');
            
            if (!token) {
                alert('Please login first');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${name}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/products/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Product deleted successfully!');
                    loadProducts();
                } else {
                    showError(data.error || 'Failed to delete product');
                }
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }
        
        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
        }
        
        function closeFormModal() {
            document.getElementById('formModal').style.display = 'none';
        }
        
        window.onclick = function(event) {
            const productModal = document.getElementById('productModal');
            const formModal = document.getElementById('formModal');
            
            if (event.target == productModal) {
                productModal.style.display = 'none';
            }
            if (event.target == formModal) {
                formModal.style.display = 'none';
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            successDiv.textContent = 'âœ… ' + message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>